name: Azure ARM

on:
  push:
    branches: [ "feature2/psrule-conditional" ]

  workflow_dispatch:

jobs:
  PSRule-Analysis:
    runs-on: ubuntu-latest

    steps:
    # Checkout code
    - uses: actions/checkout@v2

      #- name: Check ACR Modules
      #  shell: pwsh
      #  run: |
      #    $file = "deployment/main.bicep"
  
      #    # Read the content of the file
      #    $fileContent = Get-Content -Path $file -Raw
    
      #    # Search for occurrences of 'br:'
      #    $brMatches = $fileContent | Select-String -Pattern 'br:'
      #    #$azurecrMatches = $fileContent | Select-String -Pattern '.azurecr.io'
    
      #    # Output the results
      #    if ($brMatches) {
      #       Write-Output "[PASS] Required ACR modules is being used"
      #    } else {
      #        Write-Output "[FAIL]: Required ACR modules is not been used`n RECOMMEND: Consider using the allowed modules "
      #        exit 1 
      #    }

    - name: Check ACR Modules
      shell: pwsh
      run: |
        $file = "deployment/main.bicep"

        # Read the content of the file
        $fileContent = Get-Content -Path $file

        # Check if all lines starting with "module" contain 'br:vidalabacr.azurecr.io'
        $pass = $true
        foreach ($line in $fileContent | Where-Object { $_ -match '^module' }) {
            if ($line -notmatch 'br:vidalabacr.azurecr.io/') {
                Write-Output "[FAIL] Line '$line' does not contain the required ACR modules'."
                $pass = $false
            }
        }

        if ($pass) {
            Write-Output "[PASS] Required ACR modules are being used"
        }
        else {
            exit 1
        }
        Start-Sleep -Seconds 10
                            
    # Log into Azure
    - name: Login to Azure  
      uses: azure/login@v1.4.3
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Run PSRule analysis
      uses: microsoft/ps-rule@v2.9.0
      with:
        version: '1.11.1'
        modules: 'PSRule.Rules.Azure'
 
  Preview-Bicep-Changes:
    needs: [PSRule-Analysis]
    runs-on: ubuntu-latest

    steps:
    # Checkout code
    - uses: actions/checkout@v2
                    
    # Log into Azure
    - name: Login to Azure  
      uses: azure/login@v1.4.3
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
  
    - name: Preview Changes from Bicep
      uses: Azure/deployment-what-if-action@v1.0.0
      with:
        subscription: ${{ secrets.AZURE_SUBSCRIPTION }} 
        resourceGroup: ${{ secrets.AZURE_RG }} 
        templateFile: deployment/main.bicep
        
  Deploy-Azure-from-ACR:
    environment: Deployment-POC
    needs: [Preview-Bicep-Changes]
    runs-on: ubuntu-latest

    steps:
    # Checkout code
    - uses: actions/checkout@main

    # Log into Azure
    - uses: azure/login@v1.4.3
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Deploy Bicep file
    - name: Deployment Bicep Resources
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ secrets.AZURE_RG }}
        template: deployment/main.bicep
        #parameters: 'storagePrefix=mystore storageSKU=Standard_LRS'
        failOnStdErr: false